---
title: "Github Workflow ã§ compositeã‚’ä½¿ã£ã¦å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã‚‹ - slackç·¨"
emoji: "ğŸ´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GithubActions"]
published: true
---

[composite]:https://github.blog/changelog/2021-08-25-github-actions-reduce-duplication-with-action-composition/
[ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ]:https://docs.github.com/ja/actions/learn-github-actions/contexts#github-context

# ã‚„ã‚ŠãŸã„ã“ã¨
workflowã®ä¸­ã§ç¹°ã‚Šè¿”ã•ã‚Œã‚‹å†…å®¹ã‚’å†åˆ©ç”¨ã—ãŸã„ğŸ´
ä»Šå›ã¯slackã®é€šçŸ¥ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸğŸ´

# ã‚„ã‚‹ã“ã¨

1. ãƒªãƒã‚¸ãƒˆãƒªã«`.github/actions/<ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå>/action.yml`ã‚’è¿½åŠ 
2. action.ymlã®å†…å®¹è¿½åŠ 
3. æ—¢å­˜ã®workflowã®stepsã‚’ç½®ãæ›ãˆ

# ã‚µãƒ³ãƒ—ãƒ«workflow

ä»Šå›å†åˆ©ç”¨ã—ã¦ã¿ã‚‹workflowã®å†…å®¹ã§ã™ğŸ´
ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Œäº†ã™ã‚‹ã¨ã€slackã«é€šçŸ¥ã™ã‚‹æµã‚Œã«ãªã‚Šã¾ã™ã€‚

æˆåŠŸã—ã¦ã‚‚ã€å¤±æ•—ã—ã¦ã‚‚ã€slackã«ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€šçŸ¥ã™ã‚‹ã®ã§ã™ãŒ
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•ã†ã ã‘ã§ã™ã€‚
ã“ã‚Œã‚’[composite]ã‚’ä½¿ç”¨ã—ã¦ã€å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã¦ã¿ã¾ã™ğŸ´

```yml:.github/workflows/deploy.yml
# name, onçœç•¥

env:
  SUCCESS_MESSAGE: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã—ã¾ã—ãŸ
  FAILED_MESSAGE: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã—ã¾ã—ãŸ
  SLACK_ICON: https://sample.png

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      #è©³ç´°çœç•¥
        continue-on-error: true

  notify-slack:
    needs: deploy
    if: ${{ always() }}
    name: Notify Slack
    runs-on: ubuntu-latest
    steps:
      - name: Success notification
        if: ${{ needs.deploy.result == 'success' }}
        uses: rtCamp/action-slack-notify@master
        env:
          SLACK_CHANNEL: sample-channel
          SLACK_USERNAME: Github Actions
          SLACK_ICON: ${{ env.SLACK_ICON }}
          SLACK_COLOR: good
          SLACK_TITLE: ${{ github.repository }}
          SLACK_MESSAGE: ${{ env.SUCCESS_MESSAGE }}
          SLACK_FOOTER: ${{ github.workflow }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Failed notification
        if: ${{ needs.deploy.result == 'failure' }}
        uses: rtCamp/action-slack-notify@master
        env:
          SLACK_CHANNEL: sample-channel
          SLACK_USERNAME: Github Actions
          SLACK_ICON: ${{ env.SLACK_ICON }}
          SLACK_TITLE: ${{ github.repository }}
          SLACK_FOOTER: ${{ github.workflow }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_MESSAGE: ${{ env.FAILED_MESSAGE }}
```

ãƒã‚¤ãƒ³ãƒˆã¯ã€Github Actionsã§ã®ymlè¨˜æ³•ã¯ã‚¢ãƒ³ã‚«ãƒ¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã®ã§
åŒã˜å†…å®¹ã‚’è¤‡æ•°å›è¨˜è¿°ã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ğŸ’¦
ã“ã‚Œã¯[issue](https://github.community/t/support-for-yaml-anchors/16128)ã§ã‚‚å–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€é•·ã„é–“æ”¹å–„ã•ã‚Œãªã„ã®ã§ã™ãŒã€ãã‚Œã®æ•‘ä¸–ä¸»ã¨ãªã£ãŸã®ãŒ[composite]ã§ã™ğŸ´

## 1. ãƒªãƒã‚¸ãƒˆãƒªã«`.github/actions/<ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå>/action.yml`ã‚’è¿½åŠ 

ä»Šå›ã¯slackã§é€šçŸ¥ã™ã‚‹ã®ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã¯slackã«ã—ã¾ã—ãŸğŸ´

## 2. action.ymlã®å†…å®¹è¿½åŠ 

action.ymlã«ç§»å‹•ã—ãŸæ™‚ã«æ³¨æ„ã™ã‚‹ã®ãŒ

1. secretsã¯ä½¿ç”¨ã§ããªã„ã®ã§ã€inputsã§å—ã‘å–ã‚‹ã‚ˆã†ã«ã™ã‚‹
2. shellã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã¯ã€shellã‚’æŒ‡å®šã—ãªã„ã¨ã„ã‘ãªã„

ä»Šå›ã¯ã€shellã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã®ã§ã€2ã¯ä¸è¦ã§ã™ğŸ´

- `SLACK_WEBHOOK`ã‚’ secrets â†’ inputs ã«å¤‰æ›´ã—ã¾ã—ãŸ
- `github.~`ã¯,CIä¸Šã§ä½¿ç”¨ã§ãã‚‹å¤‰æ•°ã¿ãŸã„ãªã‚‚ã®ã§ã™([ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ])
- `using: 'composite'`ã‚’å®£è¨€ã—ã¦ã‚‹ã®ãŒç‰¹å¾´çš„ã§ã™ã­
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã§ãã‚‹ã®ã§ã€å¤‰æ›´ã—ãŸã„å€¤ã ã‘æ¸¡ã›ã°ã‚ˆããªã‚Šã¾ã—ãŸğŸ´

```yml:.github/actions/slack/action.yml
name: Notify Slack

description: Notify Slack

inputs:
  slack_icon_url:
    description: Slack icon
    default: https://sample.png
    required: false
  message:
    description: Message
    default: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã—ã¾ã—ãŸ ğŸ’¯
    required: false
  color:
    description: Color
    default: good # good, danger, warning
    required: false

runs:
  using: 'composite'
  steps:
    - name: Success notification
      uses: rtCamp/action-slack-notify@master
      env:
        SLACK_CHANNEL: pcm-system
        SLACK_USERNAME: Github Actions
        SLACK_ICON: ${{ inputs.slack_icon_url }}
        SLACK_COLOR: ${{ inputs.color }}
        SLACK_TITLE: ${{ github.repository }}
        SLACK_MESSAGE: ${{ inputs.message }}
        SLACK_FOOTER: ${{ github.workflow }}
        SLACK_WEBHOOK: ${{ inputs.SLACK_WEBHOOK_URL }}
```

## 3. æ—¢å­˜ã®workflowã®stepsã‚’ç½®ãæ›ãˆ

```yml:.github/workflows/deploy.yml
# name, onçœç•¥

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      #è©³ç´°çœç•¥
        continue-on-error: true

  notify-slack:
    needs: deploy
    if: ${{ always() }}
    name: Notify Slack
    runs-on: ubuntu-latest
    steps:
      - name: Notify Success
        uses: ./.github/actions/slack
        if: ${{ needs.deploy.result == 'success' }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Failed
        if: ${{ needs.deploy.result == 'success' }}
        with:
          message: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã—ã¾ã—ãŸ ğŸ’£
          color: danger
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
```

ã ã„ã¶ã™ã£ãã‚Šã—ã¾ã—ãŸã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæˆåŠŸæ™‚ã«åˆã‚ã›ã¦ã„ã‚‹ã®ã§ã€withã§æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯å¤±æ•—æ™‚ã®messageã¨colorã ã‘ã§æ¸ˆã¿ã¾ã—ãŸğŸ´
action.ymlã§ã‚‚secretsãŒæ¸¡ã›ã‚Œã°ã€ã‚‚ã£ã¨ä¾¿åˆ©ã«ãªã‚Šãã†ã§ã™ãŒã€ä»Šç¾åœ¨ã¯ã§ããªã„ãã†ã§ã™ã€‚
ä»Šå¾Œ[secretsã‚‚action.ymlã§å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã£ã½ã„æ„å›³ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/actions/runner/blob/main/docs/adrs/0549-composite-run-steps.md#secrets)ã«ã‚ã‚‹ã®ã§ã€ä»Šå¾Œã«æœŸå¾…ã§ã™ğŸ´

ç¾å ´ã‹ã‚‰ã¯ä»¥ä¸Šã§ã™ğŸ´