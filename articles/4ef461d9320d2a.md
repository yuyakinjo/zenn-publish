---
title: "ç’°å¢ƒåˆ¥ã« Angular ã§ Google Analytics 4 ã®è¨­å®šã‚’ã™ã‚‹"
emoji: "ğŸ´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["angular","analytics"]
published: true
---

Angular(typescriptã§) ã§ Google Analytics 4(ä»¥ä¸‹GA) ã®è¨­å®šã™ã‚‹æ–¹æ³•ãŒã¾ã è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã€ã“ã¡ã‚‰ã‚’è©¦ã—ã¾ã—ãŸã€‚
ä»Šå›ã¯`ngx-angular-analytics`ã®ã‚ˆã†ãªãƒ©ãƒƒãƒ‘ãƒ¼ã§ã¯ãªãã€ã‚·ãƒ³ãƒ—ãƒ«ã«`gtag.js`ã‚’ä½¿ã†ã‚ˆã†ãªè¨­å®šã§ã™ã€‚


# è©¦ã—ãŸç’°å¢ƒ

- "@angular/cli": "~13.0.3"
- "@angular/core": "~13.0.2"
- "typescript": "~4.4.4"

# GA ã® æº–å‚™

![](https://storage.googleapis.com/zenn-user-upload/6094947fee74-20211213.png)

1. æ¸¬å®šID (ä¸Šã®ã‚¹ã‚¯ã‚·ãƒ§ã®ç·‘æ )
2. `index.html` ã«è²¼ã‚Šä»˜ã‘ã‚‹scriptã‚¿ã‚° (ä¸Šã®ã‚¹ã‚¯ã‚·ãƒ§ã®èµ¤æ )

ä¸Šè¨˜ã¾ã§ã®è¨­å®šå€¤ã®å–å¾—ã¾ã§ã¯ã€[å…¬å¼ã®ãƒšãƒ¼ã‚¸ãªã©ã§å‚ç…§](https://support.google.com/analytics/answer/9304153?hl=ja&ref_topic=9303319#zippy=%2C%E3%82%A6%E3%82%A7%E3%83%96)ã—ã¦ãã ã•ã„ã€‚


# Angular ã« GA ã® è¨­å®š

## 1. index.html ã« GA ã®è¨­å®šã‚’è¿½åŠ 

headã‚¿ã‚°ã®ä¸€ç•ªä¸‹ã«ã€GAã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ğŸ´

ç’°å¢ƒåˆ¥(ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»æœ¬ç•ª)ã§ æ¸¬å®šID ã‚’å¤‰ãˆã‚‹å ´åˆã«ã‚‚å¯¾å¿œã™ã‚‹ãŸã‚ã€è¨­å®šãƒšãƒ¼ã‚¸ã«è²¼ã£ã¦ã‚ã‚‹ã‚¿ã‚°(ã‚¹ã‚¯ã‚·ãƒ§ã®èµ¤æ )ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ¶ˆã—ã¦ã¾ã™ğŸ´

ç’°å¢ƒåˆ¥ã«åˆ†ã‘ã‚‹å¿…è¦ãŒãªã„å ´åˆã€èµ¤æ ã®ã‚¿ã‚°ã‚’ãã®ã¾ã¾ãƒ™ã‚¿è²¼ã‚Šã§å¤§ä¸ˆå¤«ã§ã™ğŸ´

```diff html:index.html

  <!DOCTYPE html>
  <html lang="ja">
    <head>
      # ä»–çœç•¥
+    <script async src="https://www.googletagmanager.com/gtag/js"></script>
+    <script>
+      window.dataLayer = window.dataLayer || [];
+      function gtag() {
+        dataLayer.push(arguments);
+      }
+    </script>
    </head>
    <body>
      <app-root></app-root>
    </body>
  </html>


```

## 2. ä½¿ç”¨ã™ã‚‹ npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 

Angular ãŒ è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ `package.json` ã« GA ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ã—ã¾ã™ğŸ´


```fish
npm i -D @types/gtag.js
```

```diff json:package.json
{
  "devDependencies": {
     # ä»–çœç•¥
+    "@types/gtag.js": "^0.0.8",
  }
}
```

## 3. tsconfig.app.json ã« GA ã®è¨­å®šã‚’è¿½åŠ 

@types/gtag.js ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€TSãŒè¦‹ã¤ã‘ã‚‰ã‚Œãšã€
`TS2304: Cannot find name 'gtag'.` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ğŸ´

TSã«è¦‹ã¤ã‘ã¦ã‚‚ã‚‰ã†ãŸã‚ã€`tsconfig.app.json` ã« types ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ğŸ´

```diff json:tsconfig.app.json
/* To learn more about this file see: https://angular.io/config/tsconfig. */
{
  "compilerOptions": {
    # ä»–çœç•¥
-    "types": [""],
+    "types": ["gtag.js"]
  },
}

```

## 4. ç’°å¢ƒåˆ¥ã®è¨­å®šã‚’è¿½åŠ 

GAã®æº–å‚™ã§æ¸¬å®šIDã‚’`enviroment.ts`ã«è¨˜è¿°ã—ã¾ã™ã€‚
ç’°å¢ƒåˆ¥ã«ã‚ã‚‹å ´åˆã¯ã€å„ç’°å¢ƒåˆ¥ã«è¨­å®šã—ã¾ã—ã‚‡ã†ğŸ´
ä»Šå›ã¯ä¾‹ã¨ã—ã¦ã€`environment.prod.ts`ã«è²¼ã£ã¦ã„ã¾ã™ã€‚

devç’°å¢ƒã§ã¯ã€`environment.ts` ã®`gtagId`ãŒè¨­å®šã•ã‚Œã€prodç’°å¢ƒã§ã¯ã€`environment.prod.ts` ã®`gtagId`ãŒè¨­å®šã•ã‚Œã¾ã™ğŸ´


```diff ts:environment.ts
export const env {
+ gtagId: 'G-XXXXXXXXXXXX',
}
```

```diff ts:environment.prod.ts
export const env {
+ gtagId: 'G-XXXXXXXXXXXX',
}
```

## 5. main.ts ã« GA ã®è¨­å®šã‚’è¿½åŠ 

```diff ts:main.ts

+ import { env } from './environments/environment';

+ // google analytics
+ gtag('js', new Date());
+ gtag('config', env.gtagId);

```

ã“ã‚Œã§å®Œäº†ã§ã™ã€‚
Angular ã® tsãƒ•ã‚¡ã‚¤ãƒ«å†…ã§`gtag`ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

ã‚ã¨ã¯ã€Angular ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ `gtag` é–¢æ•°ã‚’æ€ã„ã®ã¾ã¾ä½¿ã†ã ã‘ã§ã™ğŸ´

gtagã®ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡å†…å®¹ãªã©ã¯ã“ã¡ã‚‰
https://developers.google.com/analytics/devguides/collection/gtagjs/events?hl=ja