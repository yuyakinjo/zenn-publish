---
title: "NestJS ã§ ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿- ã¿ãŸã„ãªã“ã¨ã‚’ã—ãŸã„"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nestjs"]
published: true
---

[Railsã®ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼]:https://railsguides.jp/action_controller_overview.html#strong-parameters
[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]:https://docs.nestjs.com/
[stripping-properties]:https://docs.nestjs.com/techniques/validation#stripping-properties

# èƒŒæ™¯

DTOã§Validationã‚’å®Ÿè£…ã—ãŸã¯ã„ã„ã‘ã©ã€DTOã§å®šç¾©ã—ã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ãŸã„ã€‚
[Railsã®ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼] ã® `permit` ã«ã‚ãŸã‚‹æ©Ÿèƒ½ã‚’ NestJS ã§æ¢ã—ã¦ã„ãŸã®ã§ã™ãŒã€åç§°ãŒé•ã†ã®ã§ã“ã“ã§ç´ä»˜ã‘ã¦ãŠãã¾ã™ã€‚

# ç’°å¢ƒ

- @nestjs/core (v8.0.0)

# ã‚„ã‚ŠãŸã„ã“ã¨

[Railsã®ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼] ã® `permit` ã‚’ NestJS ã§ã‚‚å®Ÿè£…ã—ãŸã„ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ãŸã¨ã—ã¾ã™ã€‚

```json
// POST localhost:3000
{
    "id": "1",
    "age": 29,
    "name": "bob"
}
```

ä¸Šè¨˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Bodyã‹ã‚‰å—ã‘å–ã‚ŠãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `validation` ã—ã¤ã¤ã€`validation` ã‚’é€šéã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã ã‘ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å´ã§å—ã‘å–ã‚Šã€ãã‚Œä»¥å¤–ã¯é™¤å¤–ã—ãŸã„ã€‚

ä¸Šè¨˜ã§`validation`ã‚’è¡Œã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯`id`,`age`ã ã‘ã®å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

â€» Railsã§ã„ã†ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªè¨­å®šã«ãªã‚‹ã¯ãšã§ã™ã€‚

```ruby:app/controllers/app_controller.rb
params.permit(:id, :age)
```

ã™ã‚‹ã¨ã€paramsã‹ã‚‰å–å¾—ã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã¯ãšã§ã™ã€‚

```json
// POST localhost:3000
{
    "id": "1",
    "age": 29,
}
```

`name`ã¯è¨±å¯(permit)ã•ã‚Œã¦ã„ãªã„ã®ã§é™¤å¤–ã•ã‚Œã¦ã„ã¾ã™ã€‚


# ãªãœã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„ã®ã‹

1. `validation`ã‚’é€šéã—ã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ãŸã„
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼é¸åˆ¥ä½œæ¥­ãŒé¢å€’ãªãŸã‚

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å´ã§`validation`ã¤ã„ã§ã«å¿…è¦ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’é™¤å¤–ã—ãŸã»ã†ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚å®‰å…¨ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’é¸åˆ¥ãŒä¸è¦ã«ãªã‚Šä¸€çŸ³äºŒé³¥ã§ã™ğŸ”

Railsã§ã¯å®Ÿè£…æ–¹æ³•ãŒRailsãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãªã©ã§ã€ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ‰±ã†ã®ã§ä¸€èˆ¬çš„ã§ã™ãŒã€NestJSã®å ´åˆã©ã†ã™ã‚‹ã®ã‹ã™ãå‡ºã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]ã‚’æ¼ã‚‹ã¨ã€NestJSã®å ´åˆã€`validation`ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®é™¤å¤–ã¯DTOã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€`whitelist`ã‚’`true`ã«ã™ã‚‹ã“ã¨ã§å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
[Railsã®ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼]ã®`permit`ã¯ã€NestJSã§ã¯[stripping-properties]ã¨å‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã§ã™ã­ã€‚

# `whitelist` ã‚’ `true` ã«è¨­å®š

ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã—ãŸã„å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«, `bootstrap`ä¸Šã§å®šç¾©ã—ã¾ã™ã€‚

```diff ts:main.ts
import { ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
+  app.useGlobalPipes(new ValidationPipe({ whitelist: true }));
  await app.listen(3000);
}
bootstrap();
```

å€‹åˆ¥ã«ãƒ¡ã‚½ãƒƒãƒ‰å˜ä½ã§å®šç¾©ã™ã‚‹å ´åˆã¯ã€controllerã‚„resolverå˜ä½ã§è¨­å®šã§ãã¾ã™ã€‚

```diff ts:app.controller.ts
import { Body, Controller, Get, Param, Post, Query, UsePipes, ValidationPipe } from '@nestjs/common';
import { GreetingDto } from './greeting-dto';

@Controller()
export class AppController {
  @Post()
+ @UsePipes(new ValidationPipe({ whitelist: true }))
  getGreeting(@Body() greeting: GreetingDto) {
    return greeting;
  }
}
```

# æ³¨æ„
whitelistã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã¯ã€`class-validator`ã¨`class-transformer`ã‚’installã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Œã°è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```fish
npm i class-validator class-transformer
```

# POSTã®å ´åˆ

ã•ãã»ã©ã€`id`ã¨`age`ã‚’`validation`ã‚’è¡Œã†DTOãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—`validation`ã‚’è¡Œã„ã¾ã™ã€‚

```ts:greeting-dto.ts
import { Transform } from 'class-transformer';
import { IsNumber, IsNumberString, IsOptional } from 'class-validator';

export class GreetingDto {
  @IsNumberString()
  id: string;

  @IsNumber()
  age: number;
}

```

ä¸Šè¨˜ã®DTOãƒ•ã‚¡ã‚¤ãƒ«ã‚’getGreetingã®å‹ã«ä½¿ç”¨ã™ã‚‹ã¨ã€NestJSãŒ`validation`ã‚’è¡Œã†è¨­å®šãŒã§ãã¾ã—ãŸã€‚

```ts:app.controller.ts
import { Body, Controller, Get, Param, Post, Query, UsePipes, ValidationPipe } from '@nestjs/common';
import { GreetingDto } from './greeting-dto';

@Controller()
export class AppController {
  @Post()
  @UsePipes(new ValidationPipe({ whitelist: true }))
  getGreeting(@Body() greeting: GreetingDto) {
    return greeting;
  }
}
```

## `whitelist` ãŒ `false`(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) ã®ã¨ã

```fish
POST localhost:3000
```

```json:body
{
    "id": "1",
    "age": 29,
    "name": "bob"
}
```

```json:response
{
  "id": "1",
  "age": 29,
  "name": "bob"
}
```

## `whitelist` ãŒ `true` ã®ã¨ã

```fish
POST localhost:3000
```

```json:body
{
  "id": "1",
  "age": 29,
  "name": "bob"
}
```

```json:response
{
  "id": "1",
  "age": 29
}
```

ã¡ã‚ƒã‚“ã¨ã€DTOã§å®šç¾©ã•ã‚Œã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚

# å‚è€ƒ

[NestJS Validation stripping-properties](https://docs.nestjs.com/techniques/validation#stripping-properties)